{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Metagraph Explorer{% endblock %}

{% block content %}
<style>
    .explorer-container {
        padding: 20px 0;
    }
    .explorer-controls {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        align-items: flex-end;
        flex-wrap: wrap;
    }
    .control-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .control-group label {
        font-weight: bold;
        font-size: 12px;
        color: var(--body-quiet-color, #666);
    }
    .control-group select, .control-group input {
        padding: 10px 12px;
        border: 1px solid var(--hairline-color, #ccc);
        border-radius: 4px;
        font-size: 14px;
        min-width: 200px;
        height: 42px;
        line-height: 1.4;
    }
    .btn-load {
        padding: 0 20px;
        background: var(--primary, #417690);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        height: 42px;
        line-height: 42px;
    }
    .btn-load:hover {
        background: var(--primary-fg, #205067);
    }
    .btn-load:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    .summary-cards {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .summary-card {
        background: var(--darkened-bg, #f8f8f8);
        border: 1px solid var(--hairline-color, #e0e0e0);
        border-radius: 6px;
        padding: 15px 20px;
        min-width: 120px;
    }
    .summary-card .value {
        font-size: 24px;
        font-weight: bold;
        color: var(--body-fg, #333);
    }
    .summary-card .label {
        font-size: 12px;
        color: var(--body-quiet-color, #666);
        margin-top: 4px;
    }
    .data-table-container {
        overflow-x: auto;
        border: 1px solid var(--hairline-color, #e0e0e0);
        border-radius: 6px;
    }
    .data-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
    }
    .data-table th {
        background: var(--darkened-bg, #f5f5f5);
        padding: 10px 12px;
        text-align: left;
        font-weight: bold;
        border-bottom: 2px solid var(--hairline-color, #ddd);
        white-space: nowrap;
        cursor: pointer;
        user-select: none;
    }
    .data-table th:hover {
        background: var(--close-button-bg, #e8e8e8);
    }
    .data-table th.sorted-asc::after {
        content: " ▲";
        font-size: 10px;
    }
    .data-table th.sorted-desc::after {
        content: " ▼";
        font-size: 10px;
    }
    .data-table td {
        padding: 8px 12px;
        border-bottom: 1px solid var(--hairline-color, #eee);
    }
    .data-table tr:hover {
        background: var(--darkened-bg, #f9f9f9);
    }
    .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: bold;
    }
    .badge-validator {
        background: #d4edda;
        color: #155724;
    }
    .badge-miner {
        background: #cce5ff;
        color: #004085;
    }
    .badge-active {
        background: #d4edda;
        color: #155724;
    }
    .badge-inactive {
        background: #f8d7da;
        color: #721c24;
    }
    .badge-immune {
        background: #fff3cd;
        color: #856404;
    }
    .loading {
        text-align: center;
        padding: 40px;
        color: var(--body-quiet-color, #666);
    }
    .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }
    .hotkey-cell {
        font-family: monospace;
        font-size: 12px;
    }
    .hotkey-cell .label {
        font-weight: bold;
        color: var(--primary, #417690);
    }
    .hotkey-link {
        color: var(--link-fg, #417690);
        cursor: pointer;
        text-decoration: underline;
    }
    .hotkey-link:hover {
        color: var(--link-hover-color, #205067);
    }
    /* Modal styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    .modal-content {
        background: var(--body-bg, white);
        border-radius: 8px;
        padding: 24px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--hairline-color, #ddd);
    }
    .modal-header h2 {
        margin: 0;
        font-size: 18px;
    }
    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--body-quiet-color, #666);
        padding: 0;
        line-height: 1;
    }
    .modal-close:hover {
        color: var(--body-fg, #333);
    }
    .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }
    .detail-item {
        padding: 10px;
        background: var(--darkened-bg, #f5f5f5);
        border-radius: 4px;
    }
    .detail-item.full-width {
        grid-column: 1 / -1;
    }
    .detail-item .label {
        font-size: 11px;
        color: var(--body-quiet-color, #666);
        margin-bottom: 4px;
        text-transform: uppercase;
    }
    .detail-item .value {
        font-size: 14px;
        font-weight: 500;
        word-break: break-all;
    }
    .detail-item .value.mono {
        font-family: monospace;
        font-size: 12px;
    }
    .validator-reason {
        margin-top: 20px;
        padding: 15px;
        border-radius: 6px;
    }
    .validator-reason.is-validator {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    .validator-reason.is-miner {
        background: #cce5ff;
        border: 1px solid #b8daff;
        color: #004085;
    }
    .validator-reason h3 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: inherit;
    }
    .validator-reason ul {
        margin: 0;
        padding-left: 20px;
    }
    .validator-reason li {
        margin: 5px 0;
        font-size: 13px;
    }
    .check-mark {
        color: #28a745;
    }
    .cross-mark {
        color: #dc3545;
    }
    .number-cell {
        text-align: right;
        font-family: monospace;
    }
    th.number-header {
        text-align: right;
    }
    .filter-row {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .filter-btn {
        padding: 5px 12px;
        border: 1px solid var(--hairline-color, #ccc);
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
    .filter-btn.active {
        background: var(--primary, #417690);
        color: white;
        border-color: var(--primary, #417690);
    }
</style>

<div class="explorer-container">
    <h1>Metagraph Explorer</h1>

    <div class="explorer-controls">
        <div class="control-group">
            <label for="subnet-select">Subnet (netuid)</label>
            <select id="subnet-select">
                <option value="">Select subnet...</option>
                {% for subnet in subnets %}
                <option value="{{ subnet.netuid }}">{{ subnet.netuid }} - {{ subnet.name|default:"Unnamed" }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="control-group">
            <label for="block-select">Block (recent)</label>
            <select id="block-select" disabled>
                <option value="">Select subnet first...</option>
            </select>
        </div>

        <div class="control-group">
            <label for="block-input">Or enter block #</label>
            <input type="number" id="block-input" placeholder="Block number...">
        </div>

        <div class="control-group">
            <label for="mech-select">Mechanism</label>
            <select id="mech-select">
                <option value="0">0 (Default)</option>
                <option value="1">1</option>
                <option value="2">2</option>
            </select>
        </div>

        <button class="btn-load" id="load-btn" disabled>Load Metagraph</button>
    </div>

    <div id="error-container" class="error" style="display: none;"></div>

    <div id="summary-container" style="display: none;">
        <div class="summary-cards">
            <div class="summary-card">
                <div class="value" id="total-neurons">-</div>
                <div class="label">Total Neurons</div>
            </div>
            <div class="summary-card">
                <div class="value" id="total-validators">-</div>
                <div class="label">Validators</div>
            </div>
            <div class="summary-card">
                <div class="value" id="total-miners">-</div>
                <div class="label">Miners</div>
            </div>
            <div class="summary-card">
                <div class="value" id="total-active">-</div>
                <div class="label">Active</div>
            </div>
            <div class="summary-card">
                <div class="value" id="block-info">-</div>
                <div class="label">Block</div>
            </div>
        </div>

        <div class="filter-row">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="validator">Validators</button>
            <button class="filter-btn" data-filter="miner">Miners</button>
            <button class="filter-btn" data-filter="active">Active</button>
        </div>
    </div>

    <div id="loading-container" class="loading" style="display: none;">
        Loading metagraph data...
    </div>

    <div id="data-container" style="display: none;">
        <div class="data-table-container">
            <table class="data-table" id="metagraph-table">
                <thead>
                    <tr>
                        <th data-sort="uid" class="number-header">UID</th>
                        <th data-sort="label">Hotkey</th>
                        <th data-sort="stake_tao" class="number-header">Stake (TAO)</th>
                        <th data-sort="emissions" class="number-header">Emissions</th>
                        <th data-sort="incentive" class="number-header">Incentive</th>
                        <th data-sort="dividend" class="number-header">Dividend</th>
                        <th data-sort="trust" class="number-header">Trust</th>
                        <th data-sort="consensus" class="number-header">Consensus</th>
                        <th data-sort="validator_trust" class="number-header">V.Trust</th>
                        <th data-sort="last_update" class="number-header">Last Update</th>
                        <th>Type</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Neuron Details Modal -->
<div id="neuron-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Neuron Details</h2>
            <button class="modal-close" id="modal-close">&times;</button>
        </div>
        <div id="modal-body"></div>
    </div>
</div>

<script>
(function() {
    const subnetSelect = document.getElementById('subnet-select');
    const blockSelect = document.getElementById('block-select');
    const blockInput = document.getElementById('block-input');
    const mechSelect = document.getElementById('mech-select');
    const loadBtn = document.getElementById('load-btn');
    const errorContainer = document.getElementById('error-container');
    const summaryContainer = document.getElementById('summary-container');
    const loadingContainer = document.getElementById('loading-container');
    const dataContainer = document.getElementById('data-container');
    const tableBody = document.getElementById('table-body');

    let allData = [];
    let currentFilter = 'all';
    let currentSort = { field: 'stake_tao', direction: 'desc' };

    // Subnet selection handler
    subnetSelect.addEventListener('change', async function() {
        const subnetId = this.value;
        blockSelect.innerHTML = '<option value="">Loading blocks...</option>';
        blockSelect.disabled = true;
        loadBtn.disabled = true;

        if (!subnetId) {
            blockSelect.innerHTML = '<option value="">Select subnet first...</option>';
            return;
        }

        try {
            const response = await fetch(`/admin/metagraph/explorer/api/blocks/?subnet_id=${subnetId}`);
            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            blockSelect.innerHTML = '<option value="latest">Latest</option>';
            data.blocks.forEach(block => {
                const date = block.timestamp ? new Date(block.timestamp).toLocaleString() : 'N/A';
                blockSelect.innerHTML += `<option value="${block.number}">${block.number} (${date})</option>`;
            });
            blockSelect.disabled = false;
            loadBtn.disabled = false;
        } catch (err) {
            showError('Failed to load blocks: ' + err.message);
            blockSelect.innerHTML = '<option value="">Error loading blocks</option>';
        }
    });

    // Block input/select interaction - clear the other when one is used
    blockInput.addEventListener('input', function() {
        if (this.value.trim()) {
            blockSelect.value = '';
        }
        // Enable load button if subnet selected and block input has value
        if (subnetSelect.value && this.value.trim()) {
            loadBtn.disabled = false;
        }
    });

    blockSelect.addEventListener('change', function() {
        if (this.value) {
            blockInput.value = '';
        }
    });

    // Load button handler
    loadBtn.addEventListener('click', loadMetagraph);

    async function loadMetagraph() {
        const subnetId = subnetSelect.value;
        // Use manual input if provided, otherwise use dropdown
        const blockNumber = blockInput.value.trim() || blockSelect.value;
        const mechId = mechSelect.value;

        if (!subnetId) {
            showError('Please select a subnet');
            return;
        }
        if (!blockNumber) {
            showError('Please select a block or enter a block number');
            return;
        }

        hideError();
        loadingContainer.style.display = 'block';
        dataContainer.style.display = 'none';
        summaryContainer.style.display = 'none';
        loadBtn.disabled = true;

        try {
            const response = await fetch(`/admin/metagraph/explorer/api/data/?subnet_id=${subnetId}&block_number=${blockNumber}&mech_id=${mechId}`);
            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            allData = data.neurons;

            // Update summary
            document.getElementById('total-neurons').textContent = data.summary.total_neurons;
            document.getElementById('total-validators').textContent = data.summary.validators;
            document.getElementById('total-miners').textContent = data.summary.miners;
            document.getElementById('total-active').textContent = data.summary.active;
            document.getElementById('block-info').textContent = data.block.number;

            renderTable();

            summaryContainer.style.display = 'block';
            dataContainer.style.display = 'block';
        } catch (err) {
            showError('Failed to load metagraph: ' + err.message);
        } finally {
            loadingContainer.style.display = 'none';
            loadBtn.disabled = false;
        }
    }

    function renderTable() {
        let filtered = allData;

        // Apply filter
        if (currentFilter === 'validator') {
            filtered = allData.filter(d => d.is_validator);
        } else if (currentFilter === 'miner') {
            filtered = allData.filter(d => !d.is_validator);
        } else if (currentFilter === 'active') {
            filtered = allData.filter(d => d.is_active);
        }

        // Apply sort
        filtered.sort((a, b) => {
            let aVal = a[currentSort.field];
            let bVal = b[currentSort.field];

            if (typeof aVal === 'string') {
                aVal = aVal.toLowerCase();
                bVal = bVal.toLowerCase();
            }

            if (aVal === null || aVal === undefined) aVal = -Infinity;
            if (bVal === null || bVal === undefined) bVal = -Infinity;

            if (currentSort.direction === 'asc') {
                return aVal > bVal ? 1 : -1;
            } else {
                return aVal < bVal ? 1 : -1;
            }
        });

        // Update sort indicators
        document.querySelectorAll('.data-table th').forEach(th => {
            th.classList.remove('sorted-asc', 'sorted-desc');
            if (th.dataset.sort === currentSort.field) {
                th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }
        });

        // Render rows
        tableBody.innerHTML = filtered.map((d, idx) => `
            <tr>
                <td class="number-cell">${d.uid}</td>
                <td class="hotkey-cell">
                    ${d.label ? `<span class="label">${d.label}</span><br>` : ''}
                    <span class="hotkey-link" data-neuron-idx="${idx}" title="${d.hotkey_full}">${d.hotkey}</span>
                </td>
                <td class="number-cell">${d.stake_tao.toLocaleString(undefined, {maximumFractionDigits: 2})}</td>
                <td class="number-cell">${d.emissions.toLocaleString(undefined, {maximumFractionDigits: 6})}</td>
                <td class="number-cell">${d.incentive.toFixed(6)}</td>
                <td class="number-cell">${d.dividend.toFixed(6)}</td>
                <td class="number-cell">${d.trust.toFixed(4)}</td>
                <td class="number-cell">${d.consensus.toFixed(4)}</td>
                <td class="number-cell">${d.validator_trust.toFixed(4)}</td>
                <td class="number-cell">${d.last_update !== null ? d.last_update : '-'}</td>
                <td>
                    <span class="badge ${d.is_validator ? 'badge-validator' : 'badge-miner'}">
                        ${d.is_validator ? 'Validator' : 'Miner'}
                    </span>
                </td>
                <td>
                    <span class="badge ${d.is_active ? 'badge-active' : 'badge-inactive'}">
                        ${d.is_active ? 'Active' : 'Inactive'}
                    </span>
                    ${d.is_immune ? '<span class="badge badge-immune">Immune</span>' : ''}
                </td>
            </tr>
        `).join('');

        // Add click handlers for hotkey links
        document.querySelectorAll('.hotkey-link').forEach(link => {
            link.addEventListener('click', function() {
                const idx = parseInt(this.dataset.neuronIdx);
                showNeuronDetails(filtered[idx]);
            });
        });
    }

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.filter;
            renderTable();
        });
    });

    // Sort headers
    document.querySelectorAll('.data-table th[data-sort]').forEach(th => {
        th.addEventListener('click', function() {
            const field = this.dataset.sort;
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'desc';
            }
            renderTable();
        });
    });

    function showError(message) {
        errorContainer.textContent = message;
        errorContainer.style.display = 'block';
    }

    function hideError() {
        errorContainer.style.display = 'none';
    }

    // Modal functionality
    const modal = document.getElementById('neuron-modal');
    const modalBody = document.getElementById('modal-body');
    const modalClose = document.getElementById('modal-close');

    modalClose.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeModal();
    });

    function closeModal() {
        modal.style.display = 'none';
    }

    function showNeuronDetails(neuron) {
        const checkMark = '<span class="check-mark">✓</span>';
        const crossMark = '<span class="cross-mark">✗</span>';

        // Determine validator/miner reasons
        let reasons = [];
        if (neuron.is_validator) {
            reasons.push(`${checkMark} <strong>is_validator</strong> flag is TRUE`);
            if (neuron.dividend > 0) {
                reasons.push(`${checkMark} Has non-zero dividend: ${neuron.dividend.toFixed(6)}`);
            }
            if (neuron.validator_trust > 0) {
                reasons.push(`${checkMark} Has validator trust: ${neuron.validator_trust.toFixed(6)}`);
            }
            if (neuron.has_any_weights) {
                reasons.push(`${checkMark} Has set weights on other neurons`);
            }
        } else {
            reasons.push(`${crossMark} <strong>is_validator</strong> flag is FALSE`);
            if (neuron.dividend === 0) {
                reasons.push(`${crossMark} No dividend (dividend = 0)`);
            }
            if (neuron.validator_trust === 0) {
                reasons.push(`${crossMark} No validator trust`);
            }
            if (!neuron.has_any_weights) {
                reasons.push(`${crossMark} Has not set weights`);
            }
            if (neuron.incentive > 0) {
                reasons.push(`${checkMark} Receiving incentive: ${neuron.incentive.toFixed(6)}`);
            }
        }

        modalBody.innerHTML = `
            <div class="detail-grid">
                <div class="detail-item full-width">
                    <div class="label">Hotkey</div>
                    <div class="value mono">${neuron.hotkey_full}</div>
                </div>
                ${neuron.label ? `
                <div class="detail-item full-width">
                    <div class="label">Label</div>
                    <div class="value">${neuron.label}</div>
                </div>
                ` : ''}
                <div class="detail-item">
                    <div class="label">UID</div>
                    <div class="value">${neuron.uid}</div>
                </div>
                <div class="detail-item">
                    <div class="label">Stake</div>
                    <div class="value">${neuron.stake_tao.toLocaleString(undefined, {maximumFractionDigits: 2})} TAO</div>
                </div>
                <div class="detail-item">
                    <div class="label">Emissions</div>
                    <div class="value">${neuron.emissions.toLocaleString(undefined, {maximumFractionDigits: 6})} TAO</div>
                </div>
                <div class="detail-item">
                    <div class="label">Last Update</div>
                    <div class="value">${neuron.last_update !== null ? neuron.last_update + ' blocks ago' : 'N/A'}</div>
                </div>
            </div>

            <div class="validator-reason ${neuron.is_validator ? 'is-validator' : 'is-miner'}">
                <h3>${neuron.is_validator ? '✓ This neuron is a VALIDATOR' : '○ This neuron is a MINER'}</h3>
                <ul>
                    ${reasons.map(r => `<li>${r}</li>`).join('')}
                </ul>
            </div>

            <div class="detail-grid" style="margin-top: 20px;">
                <div class="detail-item">
                    <div class="label">Incentive</div>
                    <div class="value">${neuron.incentive.toFixed(6)}</div>
                </div>
                <div class="detail-item">
                    <div class="label">Dividend</div>
                    <div class="value">${neuron.dividend.toFixed(6)}</div>
                </div>
                <div class="detail-item">
                    <div class="label">Trust</div>
                    <div class="value">${neuron.trust.toFixed(6)}</div>
                </div>
                <div class="detail-item">
                    <div class="label">Consensus</div>
                    <div class="value">${neuron.consensus.toFixed(6)}</div>
                </div>
                <div class="detail-item">
                    <div class="label">Validator Trust</div>
                    <div class="value">${neuron.validator_trust.toFixed(6)}</div>
                </div>
                <div class="detail-item">
                    <div class="label">Rank</div>
                    <div class="value">${neuron.rank.toFixed(6)}</div>
                </div>
                <div class="detail-item">
                    <div class="label">Is Active</div>
                    <div class="value">${neuron.is_active ? 'Yes' : 'No'}</div>
                </div>
                <div class="detail-item">
                    <div class="label">Is Immune</div>
                    <div class="value">${neuron.is_immune ? 'Yes' : 'No'}</div>
                </div>
                <div class="detail-item">
                    <div class="label">Has Any Weights</div>
                    <div class="value">${neuron.has_any_weights ? 'Yes' : 'No'}</div>
                </div>
            </div>
        `;

        modal.style.display = 'flex';
    }
})();
</script>
{% endblock %}
